<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.careworker.query.mapper.DashboardMapper">

    <select id="selectDashboardSummary" resultType="org.ateam.oncare.careworker.query.dto.DashboardSummaryDto">
        SELECT
            /* 오늘 일정 개수 */
            (SELECT COUNT(*)
             FROM visit_schedule
             WHERE care_worker_id = #{caregiverId}
               AND DATE(start_dt) = CURRENT_DATE) AS scheduleCount,

            /* 담당 수급자 수 (중복 제거) */
            (SELECT COUNT(DISTINCT beneficiary_id)
        FROM visit_schedule
        WHERE care_worker_id = #{caregiverId}
          AND visit_status IN ('SCHEDULED', 'IN_PROGRESS', 'DONE')) AS recipientCount,

            /* 이번 주 누적 근무시간 (분 단위 합계 / 60) */
            (SELECT COALESCE(ROUND(SUM(TIMESTAMPDIFF(MINUTE, start_dt, end_dt)) / 60.0, 1), 0)
        FROM visit_schedule
        WHERE care_worker_id = #{caregiverId}
          AND YEARWEEK(start_dt, 1) = YEARWEEK(CURRENT_DATE, 1)
          AND visit_status = 'DONE') AS workHours
    </select>

    <select id="selectUrgentNotifications" resultType="org.ateam.oncare.careworker.query.dto.UrgentNotificationDto">
        SELECT
            nl.alarm_id AS id,
            nt.title,
            nt.content AS message,
            nl.sent_at AS dueDate,
            TRUE AS isUrgent
        FROM notification_log nl
                 JOIN notification_template nt ON nl.template_id = nt.template_id
                 JOIN care_worker cw ON nl.receiver_id = cw.employee_id
        WHERE cw.id = #{caregiverId}
          AND nl.receiver_type = 'EMPLOYEE'
          AND nl.status IN ('SENT', 'FAILED')
        ORDER BY nl.sent_at DESC
            LIMIT 10
    </select>

    <select id="selectTodaySchedules" resultType="org.ateam.oncare.careworker.query.dto.HomeScheduleDto">
        SELECT
            vs.vs_id AS scheduleId,
            b.name AS recipientName,
            COALESCE(mcl.level, '등급없음') AS grade,
            CONCAT(TIME_FORMAT(vs.start_dt, '%H:%i'), ' - ', TIME_FORMAT(vs.end_dt, '%H:%i')) AS visitTime,
            b.address AS address,
            vs.visit_status AS status
        FROM visit_schedule vs
                 JOIN beneficiary b ON vs.beneficiary_id = b.id
                 LEFT JOIN (
                     SELECT beneficiary_id, id, start_date, end_date
                     FROM beneficiary_care_level bcl1
                     WHERE start_date = (
                         SELECT MAX(start_date)
                         FROM beneficiary_care_level bcl2
                         WHERE bcl2.beneficiary_id = bcl1.beneficiary_id
                     )
                 ) bcl ON b.id = bcl.beneficiary_id
                 LEFT JOIN beneficiary_count bc ON bcl.id = bc.beneficiary_care_level_id
                 LEFT JOIN m_care_level mcl ON bc.m_care_level_id = mcl.id
        WHERE vs.care_worker_id = #{caregiverId}
          AND DATE(vs.start_dt) = CURRENT_DATE
        ORDER BY vs.start_dt ASC
    </select>

    <select id="selectTodos" resultType="org.ateam.oncare.careworker.query.dto.HomeTodoDto">
        SELECT
            id AS todoId,
            todo AS content,
            clear_st AS isCompleted
        FROM todo_for_care_worker
        WHERE care_worker_id = #{caregiverId}
        ORDER BY create_at DESC
    </select>

</mapper>