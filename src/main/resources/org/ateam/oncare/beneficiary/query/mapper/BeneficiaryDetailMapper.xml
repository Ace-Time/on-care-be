<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.beneficiary.query.mapper.BeneficiaryDetailMapper">

    <resultMap id="BeneficiaryDetailMap"
               type="org.ateam.oncare.beneficiary.query.dto.response.BeneficiaryDetailResponse">

        <id property="beneficiaryId" column="beneficiary_id"/>

        <result property="name" column="name"/>
        <result property="gender" column="gender"/>
        <result property="birthdate" column="birthdate"/>
        <result property="phone" column="phone"/>
        <result property="address" column="address"/>
        <result property="status" column="status"/>

        <result property="careLevel" column="care_level"/>
        <result property="careLevelEndDate" column="care_level_end_date"/>
        <result property="riskLevel" column="risk_level"/>

        <!-- ✅ 수급자당 요양보호사 1명 => Long 유지 -->
        <result property="careWorkerId" column="care_worker_id"/>
        <result property="managerName" column="care_worker_name"/>

        <!-- ✅ 서비스유형은 여러개 가능 => 문자열로 묶어서 -->
        <result property="serviceType" column="service_types"/>

        <result property="guardianName" column="guardian_name"/>
        <result property="guardianRelation" column="guardian_relation"/>
        <result property="guardianPhone" column="guardian_phone"/>

        <result property="monthlyLimit" column="monthly_limit"/>
        <result property="usedAmount" column="used_amount"/>
        <result property="remainingAmount" column="remaining_amount"/>
        <result property="usedRate" column="used_rate"/>

        <collection property="tags"
                    ofType="string"
                    select="selectBeneficiaryTags"
                    column="beneficiary_id"/>

        <collection property="riskFactors"
                    ofType="org.ateam.oncare.beneficiary.query.dto.response.BeneficiaryDetailResponse$RiskFactorItem"
                    select="selectBeneficiaryRiskFactors"
                    column="beneficiary_id"/>
    </resultMap>

    <select id="selectBeneficiaryDetail"
            parameterType="long"
            resultMap="BeneficiaryDetailMap">
        <![CDATA[
        SELECT
            b.id AS beneficiary_id,
            b.name,
            b.gender,
            DATE_FORMAT(b.birthdate, '%Y-%m-%d') AS birthdate,
            b.phone,
            b.address,

            CASE WHEN b.status = 1 THEN '서비스 중' ELSE '서비스 해지' END AS status,

            mcl.level AS care_level,
            DATE_FORMAT(bcl.end_date, '%Y-%m-%d') AS care_level_end_date,

            CASE
                WHEN IFNULL(rsum.risk_total, 0) < 10 THEN '저위험'
                WHEN IFNULL(rsum.risk_total, 0) < 15 THEN '중위험'
                ELSE '고위험'
            END AS risk_level,

            /* ✅ 요양보호사: 최신 1건 기준 (어차피 동일 1명이라는 전제) */
            cw.id   AS care_worker_id,
            ce.name AS care_worker_name,

            /* ✅ 서비스유형: 여러개 집계 */
            st.service_types AS service_types,

            g.name AS guardian_name,
            g.relation AS guardian_relation,
            g.phone AS guardian_phone,

            mcl.monthly_limit,

            /* ✅ 사용액 = (서비스 이번달(오늘 기준 진행중으로 산정됨) 누계) + (렌탈 오늘 기준 진행중 합계) */
            /* 서비스 누계는 방문일정에서 퇴근 태그 시간 등록되면 cost_of_beneficiary에 등록됨(요양보호사가 진행) */
            (
                IFNULL((
                    SELECT cob.monthly_amount
                    FROM cost_of_beneficiary cob
                    WHERE cob.beneficiary_id = b.id
                      AND cob.month = DATE_FORMAT(CURDATE(), '%Y-%m')
                ), 0)
                +
                IFNULL((
                    SELECT SUM(cp.rental_amount)
                    FROM rental_contract rc
                    JOIN rental_product rp ON rp.rental_contract_cd = rc.id
                    JOIN care_product cp ON cp.id = rp.product_id
                    WHERE rc.beneficiary_id = b.id
                      /* ✅ 오늘 기준 진행중(또는 오늘까지) */
                      AND rc.start_date <= CURDATE()
                      AND (
                            rc.end_date IS NULL
                            OR rc.end_date >= CURDATE()
                      )
                ), 0)
            ) AS used_amount,

            /* ✅ 잔액 */
            (
                mcl.monthly_limit
                -
                (
                    IFNULL((
                        SELECT cob.monthly_amount
                        FROM cost_of_beneficiary cob
                        WHERE cob.beneficiary_id = b.id
                          AND cob.month = DATE_FORMAT(CURDATE(), '%Y-%m')
                    ), 0)
                    +
                    IFNULL((
                        SELECT SUM(cp.rental_amount)
                        FROM rental_contract rc
                        JOIN rental_product rp ON rp.rental_contract_cd = rc.id
                        JOIN care_product cp ON cp.id = rp.product_id
                        WHERE rc.beneficiary_id = b.id
                          /* ✅ 오늘 기준 진행중(또는 오늘까지) */
                          AND rc.start_date <= CURDATE()
                          AND (
                                rc.end_date IS NULL
                                OR rc.end_date >= CURDATE()
                          )
                    ), 0)
                )
            ) AS remaining_amount,

            /* ✅ 사용률 */
            ROUND(
                (
                    (
                        IFNULL((
                            SELECT cob.monthly_amount
                            FROM cost_of_beneficiary cob
                            WHERE cob.beneficiary_id = b.id
                              AND cob.month = DATE_FORMAT(CURDATE(), '%Y-%m')
                        ), 0)
                        +
                        IFNULL((
                            SELECT SUM(cp.rental_amount)
                            FROM rental_contract rc
                            JOIN rental_product rp ON rp.rental_contract_cd = rc.id
                            JOIN care_product cp ON cp.id = rp.product_id
                            WHERE rc.beneficiary_id = b.id
                              /* ✅ 오늘 기준 진행중(또는 오늘까지) */
                              AND rc.start_date <= CURDATE()
                              AND (
                                    rc.end_date IS NULL
                                    OR rc.end_date >= CURDATE()
                              )
                        ), 0)
                    )
                    / NULLIF(mcl.monthly_limit, 0)
                ) * 100
            , 1) AS used_rate

        FROM beneficiary b

        LEFT JOIN beneficiary_care_level bcl
            ON bcl.beneficiary_id = b.id

        LEFT JOIN beneficiary_count bc
            ON bc.beneficiary_care_level_id = bcl.id

        LEFT JOIN m_care_level mcl
            ON mcl.id = bc.m_care_level_id

        LEFT JOIN (
            SELECT
                rom.beneficiary_id,
                SUM(rf.score) AS risk_total
            FROM riskOfMember rom
            JOIN m_risk_factor rf ON rf.id = rom.risk_id
            GROUP BY rom.beneficiary_id
        ) rsum
            ON rsum.beneficiary_id = b.id

        /* ✅ 최신 방문 1건 */
        LEFT JOIN visit_schedule vs_done
            ON vs_done.vs_id = (
                SELECT vs2.vs_id
                FROM visit_schedule vs2
                WHERE vs2.beneficiary_id = b.id
                ORDER BY vs2.start_dt DESC
                LIMIT 1
            )

        LEFT JOIN care_worker cw
            ON cw.id = vs_done.care_worker_id

        LEFT JOIN employee ce
            ON ce.id = cw.employee_id

        /* ✅ 서비스유형 집계 */
        LEFT JOIN (
            SELECT
                vs.beneficiary_id,
                GROUP_CONCAT(DISTINCT mst.name ORDER BY mst.name SEPARATOR ', ') AS service_types
            FROM visit_schedule vs
            JOIN m_service_type mst ON mst.id = vs.service_type_id
            GROUP BY vs.beneficiary_id
        ) st ON st.beneficiary_id = b.id

        LEFT JOIN guardian g
            ON g.beneficiary_id = b.id
           AND g.is_primary = 'Y'

        WHERE b.id = #{beneficiaryId}
        LIMIT 1
        ]]>
    </select>

    <select id="selectBeneficiaryTags"
            parameterType="long"
            resultType="string">
        <![CDATA[
        SELECT pt.tag
        FROM tag_of_beneficiary tob
        JOIN personal_tag pt ON pt.id = tob.tag_id
        WHERE tob.beneficiary_id = #{beneficiaryId}
        ORDER BY pt.id
        ]]>
    </select>

    <select id="selectBeneficiaryRiskFactors"
            parameterType="long"
            resultType="org.ateam.oncare.beneficiary.query.dto.response.BeneficiaryDetailResponse$RiskFactorItem">
        <![CDATA[
        SELECT
            rf.id,
            rf.name,
            rf.score
        FROM riskOfMember rom
        JOIN m_risk_factor rf ON rf.id = rom.risk_id
        WHERE rom.beneficiary_id = #{beneficiaryId}
        ORDER BY rf.id
        ]]>
    </select>

</mapper>
