<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ateam.oncare.customer.query.mapper.CustomerManageMapper">

    <!-- 수급자 목록 조회 -->
    <select id="selectBeneficiaryList" resultType="org.ateam.oncare.customer.query.dto.CustomerManageDTO$BeneficiaryListItem">
        SELECT
        b.id AS beneficiaryId,
        b.name,
        b.phone,
        b.gender,
        b.birthdate,
        b.address,
        CONCAT(cl.id, '등급') AS careLevel,
        bcl.end_date AS careLevelEndDate,
        rl.level AS riskLevel,
        CASE WHEN b.status = 1 THEN '서비스 중' ELSE '서비스 해지' END AS status,
        b.last_counsel_date AS lastCounselDate,
        e.name AS managerName,

        /* 카테고리 플래그 계산 */
        CASE WHEN b.last_counsel_date IS NULL OR DATEDIFF(NOW(), b.last_counsel_date) > 30 THEN TRUE ELSE FALSE END AS isChurnRisk,

        CASE WHEN EXISTS (
        SELECT 1 FROM counsel_history ch
        WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 4
        AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        ) THEN TRUE ELSE FALSE END AS hasComplaint,

        CASE WHEN EXISTS (
        SELECT 1 FROM counsel_history ch
        WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 5
        AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 90 DAY)
        ) THEN TRUE ELSE FALSE END AS hasTermination,

        CASE WHEN bcl.end_date IS NOT NULL AND DATEDIFF(bcl.end_date, NOW()) BETWEEN 0 AND 90 THEN TRUE ELSE FALSE END AS isCareLevelExpiring,

        CASE WHEN c.end_date IS NOT NULL AND DATEDIFF(c.end_date, NOW()) BETWEEN 0 AND 30 THEN TRUE ELSE FALSE END AS isContractExpiring,

        CASE WHEN EXISTS (
        SELECT 1 FROM counsel_history ch
        WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 2
        AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        ) THEN TRUE ELSE FALSE END AS hasRentalCounsel

        FROM beneficiary b
        LEFT JOIN beneficiary_care_level bcl ON b.id = bcl.beneficiary_id
        AND bcl.id = (SELECT MAX(bcl2.id) FROM beneficiary_care_level bcl2 WHERE bcl2.beneficiary_id = b.id)
        LEFT JOIN m_care_level cl ON bcl.id IS NOT NULL
        LEFT JOIN m_risk_level rl ON b.risk_id = rl.id
        LEFT JOIN contract c ON b.id = c.beneficiary_id AND c.contract_status = '진행중'
        LEFT JOIN matching m ON b.id = m.beneficiary_id AND m.status = 'Y'
        LEFT JOIN care_worker cw ON m.care_worker_id = cw.id
        LEFT JOIN employee e ON cw.employee_id = e.id

        WHERE b.status = 1

        <if test="keyword != null and keyword != ''">
            AND (b.name LIKE CONCAT('%', #{keyword}, '%')
            OR b.phone LIKE CONCAT('%', #{keyword}, '%'))
        </if>

        <!-- 카테고리 필터링 -->
        <if test="category == 'CHURN_RISK'">
            <choose>
                <when test="subCategory == 'CHURN_PERIOD'">
                    AND (b.last_counsel_date IS NULL OR DATEDIFF(NOW(), b.last_counsel_date) > 30)
                </when>
                <when test="subCategory == 'COMPLAINT'">
                    AND EXISTS (
                    SELECT 1 FROM counsel_history ch
                    WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 4
                    AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)
                    )
                </when>
                <when test="subCategory == 'TERMINATION'">
                    AND EXISTS (
                    SELECT 1 FROM counsel_history ch
                    WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 5
                    AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 90 DAY)
                    )
                </when>
                <otherwise>
                    AND (
                    (b.last_counsel_date IS NULL OR DATEDIFF(NOW(), b.last_counsel_date) > 30)
                    OR EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 4 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY))
                    OR EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 5 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 90 DAY))
                    )
                </otherwise>
            </choose>
        </if>

        <if test="category == 'EXPIRATION_RISK'">
            <choose>
                <when test="subCategory == 'CARE_LEVEL'">
                    AND bcl.end_date IS NOT NULL AND DATEDIFF(bcl.end_date, NOW()) BETWEEN 0 AND 90
                </when>
                <when test="subCategory == 'CONTRACT'">
                    AND c.end_date IS NOT NULL AND DATEDIFF(c.end_date, NOW()) BETWEEN 0 AND 30
                </when>
                <otherwise>
                    AND (
                    (bcl.end_date IS NOT NULL AND DATEDIFF(bcl.end_date, NOW()) BETWEEN 0 AND 90)
                    OR (c.end_date IS NOT NULL AND DATEDIFF(c.end_date, NOW()) BETWEEN 0 AND 30)
                    )
                </otherwise>
            </choose>
        </if>

        <if test="category == 'MARKETING_OPPORTUNITY'">
            AND EXISTS (
            SELECT 1 FROM counsel_history ch
            WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 2
            AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)
            )
        </if>

        ORDER BY b.name ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 수급자 목록 총 개수 -->
    <select id="countBeneficiaryList" resultType="long">
        SELECT COUNT(DISTINCT b.id)
        FROM beneficiary b
        LEFT JOIN beneficiary_care_level bcl ON b.id = bcl.beneficiary_id
        AND bcl.id = (SELECT MAX(bcl2.id) FROM beneficiary_care_level bcl2 WHERE bcl2.beneficiary_id = b.id)
        LEFT JOIN contract c ON b.id = c.beneficiary_id AND c.contract_status = '진행중'

        WHERE b.status = 1

        <if test="keyword != null and keyword != ''">
            AND (b.name LIKE CONCAT('%', #{keyword}, '%')
            OR b.phone LIKE CONCAT('%', #{keyword}, '%'))
        </if>

        <if test="category == 'CHURN_RISK'">
            <choose>
                <when test="subCategory == 'CHURN_PERIOD'">
                    AND (b.last_counsel_date IS NULL OR DATEDIFF(NOW(), b.last_counsel_date) > 30)
                </when>
                <when test="subCategory == 'COMPLAINT'">
                    AND EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 4 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY))
                </when>
                <when test="subCategory == 'TERMINATION'">
                    AND EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 5 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 90 DAY))
                </when>
                <otherwise>
                    AND (
                    (b.last_counsel_date IS NULL OR DATEDIFF(NOW(), b.last_counsel_date) > 30)
                    OR EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 4 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY))
                    OR EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 5 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 90 DAY))
                    )
                </otherwise>
            </choose>
        </if>

        <if test="category == 'EXPIRATION_RISK'">
            <choose>
                <when test="subCategory == 'CARE_LEVEL'">
                    AND bcl.end_date IS NOT NULL AND DATEDIFF(bcl.end_date, NOW()) BETWEEN 0 AND 90
                </when>
                <when test="subCategory == 'CONTRACT'">
                    AND c.end_date IS NOT NULL AND DATEDIFF(c.end_date, NOW()) BETWEEN 0 AND 30
                </when>
                <otherwise>
                    AND (
                    (bcl.end_date IS NOT NULL AND DATEDIFF(bcl.end_date, NOW()) BETWEEN 0 AND 90)
                    OR (c.end_date IS NOT NULL AND DATEDIFF(c.end_date, NOW()) BETWEEN 0 AND 30)
                    )
                </otherwise>
            </choose>
        </if>

        <if test="category == 'MARKETING_OPPORTUNITY'">
            AND EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 2 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY))
        </if>
    </select>

    <!-- 카테고리별 카운트 -->
    <select id="selectCategoryCounts" resultType="org.ateam.oncare.customer.query.dto.CustomerManageDTO$CategoryCount">
        SELECT
            (SELECT COUNT(*) FROM beneficiary b WHERE b.status = 1 AND (b.last_counsel_date IS NULL OR DATEDIFF(NOW(), b.last_counsel_date) > 30)) AS churnRiskCount,

            (SELECT COUNT(DISTINCT ch.beneficiary_id) FROM counsel_history ch
                                                               INNER JOIN beneficiary b ON ch.beneficiary_id = b.id AND b.status = 1
             WHERE ch.counsel_category_id = 4 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)) AS complaintCount,

            (SELECT COUNT(DISTINCT ch.beneficiary_id) FROM counsel_history ch
                                                               INNER JOIN beneficiary b ON ch.beneficiary_id = b.id AND b.status = 1
             WHERE ch.counsel_category_id = 5 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 90 DAY)) AS terminationCount,

            (SELECT COUNT(*) FROM beneficiary b
                                      INNER JOIN beneficiary_care_level bcl ON b.id = bcl.beneficiary_id
             WHERE b.status = 1 AND bcl.end_date IS NOT NULL AND DATEDIFF(bcl.end_date, NOW()) BETWEEN 0 AND 90) AS careLevelExpiringCount,

            (SELECT COUNT(*) FROM beneficiary b
                                      INNER JOIN contract c ON b.id = c.beneficiary_id
             WHERE b.status = 1 AND c.contract_status = '진행중' AND c.end_date IS NOT NULL AND DATEDIFF(c.end_date, NOW()) BETWEEN 0 AND 30) AS contractExpiringCount,

            (SELECT COUNT(DISTINCT ch.beneficiary_id) FROM counsel_history ch
                                                               INNER JOIN beneficiary b ON ch.beneficiary_id = b.id AND b.status = 1
             WHERE ch.counsel_category_id = 2 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)) AS rentalCounselCount
    </select>

    <!-- 고객 관리 상세 (5단계용) -->
    <select id="selectCustomerManageDetail" resultType="org.ateam.oncare.customer.query.dto.CustomerManageDTO$CustomerManageDetail">
        SELECT
            b.id AS beneficiaryId,
            b.name,
            b.last_counsel_date AS lastCounselDate,
            DATEDIFF(NOW(), b.last_counsel_date) AS daysSinceLastCounsel,
            CASE WHEN b.last_counsel_date IS NULL OR DATEDIFF(NOW(), b.last_counsel_date) > 30 THEN TRUE ELSE FALSE END AS isChurnRisk,

            CASE WHEN EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 4 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)) THEN TRUE ELSE FALSE END AS hasComplaint,

            CASE WHEN EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 5 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 90 DAY)) THEN TRUE ELSE FALSE END AS hasTermination,

            bh.terminate_date AS plannedTerminationDate,

            bcl.end_date AS careLevelEndDate,
            DATEDIFF(bcl.end_date, NOW()) AS daysUntilCareLevelExpiry,
            CASE WHEN bcl.end_date IS NOT NULL AND DATEDIFF(bcl.end_date, NOW()) BETWEEN 0 AND 90 THEN TRUE ELSE FALSE END AS isCareLevelExpiring,

            c.end_date AS contractEndDate,
            DATEDIFF(c.end_date, NOW()) AS daysUntilContractExpiry,
            CASE WHEN c.end_date IS NOT NULL AND DATEDIFF(c.end_date, NOW()) BETWEEN 0 AND 30 THEN TRUE ELSE FALSE END AS isContractExpiring,

            CASE WHEN EXISTS (SELECT 1 FROM counsel_history ch WHERE ch.beneficiary_id = b.id AND ch.counsel_category_id = 2 AND ch.consult_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)) THEN TRUE ELSE FALSE END AS hasRentalCounsel,

            cw.id AS careWorkerId,
            e.name AS careWorkerName

        FROM beneficiary b
                 LEFT JOIN beneficiary_care_level bcl ON b.id = bcl.beneficiary_id
            AND bcl.id = (SELECT MAX(bcl2.id) FROM beneficiary_care_level bcl2 WHERE bcl2.beneficiary_id = b.id)
                 LEFT JOIN contract c ON b.id = c.beneficiary_id AND c.contract_status = '진행중'
                 LEFT JOIN beneficiary_history bh ON b.id = bh.beneficiary_id
                 LEFT JOIN matching m ON b.id = m.beneficiary_id AND m.status = 'Y'
                 LEFT JOIN care_worker cw ON m.care_worker_id = cw.id
                 LEFT JOIN employee e ON cw.employee_id = e.id

        WHERE b.id = #{beneficiaryId}
    </select>

    <!-- 최근 불만상담 조회 -->
    <select id="selectLatestComplaint" resultType="org.ateam.oncare.customer.query.dto.CustomerManageDTO$CounselSummary">
        SELECT
            ch.id AS counselId,
            ch.consult_date AS consultDate,
            ch.summary,
            ch.detail,
            ch.follow_up AS followUp,
            ch.follow_up_necessary AS followUpNecessary,
            e.name AS counselorName,
            mcc.name AS categoryName
        FROM counsel_history ch
                 LEFT JOIN employee e ON ch.counselor_id = e.id
                 LEFT JOIN m_counsel_category mcc ON ch.counsel_category_id = mcc.id
        WHERE ch.beneficiary_id = #{beneficiaryId}
          AND ch.counsel_category_id = 4
        ORDER BY ch.consult_date DESC
            LIMIT 1
    </select>

    <!-- 최근 해지상담 조회 -->
    <select id="selectLatestTermination" resultType="org.ateam.oncare.customer.query.dto.CustomerManageDTO$CounselSummary">
        SELECT
            ch.id AS counselId,
            ch.consult_date AS consultDate,
            ch.summary,
            ch.detail,
            ch.follow_up AS followUp,
            ch.follow_up_necessary AS followUpNecessary,
            e.name AS counselorName,
            mcc.name AS categoryName
        FROM counsel_history ch
                 LEFT JOIN employee e ON ch.counselor_id = e.id
                 LEFT JOIN m_counsel_category mcc ON ch.counsel_category_id = mcc.id
        WHERE ch.beneficiary_id = #{beneficiaryId}
          AND ch.counsel_category_id = 5
        ORDER BY ch.consult_date DESC
            LIMIT 1
    </select>

    <!-- 최근 렌탈상담 조회 -->
    <select id="selectLatestRentalCounsel" resultType="org.ateam.oncare.customer.query.dto.CustomerManageDTO$CounselSummary">
        SELECT
            ch.id AS counselId,
            ch.consult_date AS consultDate,
            ch.summary,
            ch.detail,
            ch.follow_up AS followUp,
            ch.follow_up_necessary AS followUpNecessary,
            e.name AS counselorName,
            mcc.name AS categoryName
        FROM counsel_history ch
                 LEFT JOIN employee e ON ch.counselor_id = e.id
                 LEFT JOIN m_counsel_category mcc ON ch.counsel_category_id = mcc.id
        WHERE ch.beneficiary_id = #{beneficiaryId}
          AND ch.counsel_category_id = 2
        ORDER BY ch.consult_date DESC
            LIMIT 1
    </select>

    <!-- 담당 요양보호사 ID 조회 -->
    <select id="selectCareWorkerId" resultType="Integer">
        SELECT cw.employee_id
        FROM matching m
                 INNER JOIN care_worker cw ON m.care_worker_id = cw.id
        WHERE m.beneficiary_id = #{beneficiaryId}
          AND m.status = 'Y'
            LIMIT 1
    </select>

</mapper>