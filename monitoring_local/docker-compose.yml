version: '3.8'

services:
  # 1. 프로메테우스 서비스
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      # 호스트의 설정 파일을 컨테이너 내부로 연결
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      # 설정 파일 지정 및 보관 기간 설정 (선택 사항)
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks:
      - monitoring-net
    extra_hosts:
      - "host.docker.internal:host-gateway" # 리눅스 환경 대비 호스트 인식용

  # 2. 그라파나 서비스
  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      # (1) 데이터 영구 저장 (재부팅해도 대시보드 안 날아가게)
      - grafana-data:/var/lib/grafana
      # (2) 위에서 만든 연동 설정 파일 자동 적용 (Provisioning)
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus # 프로메테우스가 켜진 뒤에 실행됨
    networks:
      - monitoring-net

# 네트워크 정의
networks:
  monitoring-net:
    driver: bridge

# 볼륨 정의 (그라파나 데이터 저장소)
volumes:
  grafana-data: